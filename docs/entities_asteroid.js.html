<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: entities/asteroid.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: entities/asteroid.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Asteroid entity management with object pooling.
 * Updated: 2025-06-06
 * Author: ChatGPT + Trevor Clark
 * Refactored: Phase 4 (Entities)
 * Adds object pooling to optimize asteroid memory reuse.
 */

import {

    GAME_CONFIG,

    ASTEROID_CONFIG,

    MOBILE_CONFIG

} from '@core/constants.js';



import { obstacles } from '@core/state.js';

import { isMobile } from '@utils/platform.js';

import { randomInt, randomFloat } from '@utils/mathUtils.js';

import { ObjectPool } from '@systems/poolManager.js';
import { addScorePopup } from '@ui/hud/scorePopups.js';
import { playSound } from '@systems/soundManager.js';

let obstacleMinSpeed = ASTEROID_CONFIG.BASE_MIN_SPEED;
let nextAsteroidId = 1;
const fragmentTracker = {};
let obstacleMaxSpeed = ASTEROID_CONFIG.BASE_MAX_SPEED;

// Initialize object pool
const obstaclePool = new ObjectPool(() => ({}));

/**
 * Count of new asteroids spawned.
 * @type {number}
 */
export let newAsteroidsSpawned = 0;

/**
 * Resets the count of new asteroids spawned.
 */
export function resetNewAsteroidsSpawned() {
  newAsteroidsSpawned = 0;
}

/**
 * Generates asteroid shape points.
 * @param {number} radius - Asteroid radius.
 * @param {number} numPoints - Number of shape points.
 * @returns {Array&lt;Object>} Array of point objects with x, y.
 */
function generateAsteroidShape(radius, numPoints) {
  const points = [];
  const angleIncrement = (Math.PI * 2) / numPoints;
  for (let i = 0; i &lt; numPoints; i++) {
    const angle = i * angleIncrement;
    const r = radius * (0.8 + Math.random() * 0.4);
    points.push({
      x: r * Math.cos(angle),
      y: r * Math.sin(angle)
    });
  }
  return points;
}

/**
 * Creates and spawns a single obstacle.
 * @param {number} x - X position.
 * @param {number} y - Y position.
 * @param {number} levelIndex - Asteroid level index.
 * @param {number} [initialDx=0] - Initial X velocity.
 * @param {number} [initialDy=0] - Initial Y velocity.
 * @param {number|null} [parentId=null] - Parent asteroid ID.
 */
function createObstacle(x, y, levelIndex, initialDx = 0, initialDy = 0, parentId = null) {
  const radius = ASTEROID_CONFIG.LEVEL_SIZES[levelIndex];
  const scoreValue = ASTEROID_CONFIG.SCORE_VALUES[levelIndex];
  const basePoints = randomInt(ASTEROID_CONFIG.SHAPE_POINTS_MIN, ASTEROID_CONFIG.SHAPE_POINTS_MAX);
  const numPoints = isMobile() ? Math.min(basePoints, MOBILE_CONFIG.MAX_SHAPE_POINTS) : basePoints;
  const shape = generateAsteroidShape(radius, numPoints);

  const id = nextAsteroidId++;
  if (parentId === null) {
    fragmentTracker[id] = 0;
  }
  const assignedParentId = parentId ?? id;
  if (typeof fragmentTracker[assignedParentId] === 'undefined') {
    fragmentTracker[assignedParentId] = 0;
  }
  if (levelIndex === ASTEROID_CONFIG.LEVEL_SIZES.length - 1) {
    fragmentTracker[assignedParentId]++;
  }

  const baseSpeed = randomFloat(obstacleMinSpeed, obstacleMaxSpeed);
  const speed = parentId === null ? baseSpeed : baseSpeed * ASTEROID_CONFIG.FRAGMENT_SPEED_MULTIPLIER;
  const rotation = Math.random() * 2 * Math.PI;
  const rotationSpeed = randomFloat(ASTEROID_CONFIG.ROTATION_SPEED_MIN, ASTEROID_CONFIG.ROTATION_SPEED_MAX);
  const now = Date.now();

  // Use the pool manager
  const obstacle = obstaclePool.acquire();

  // Reset properties
  Object.assign(obstacle, {
    x,
    y,
    radius,
    speed,
    dx: initialDx,
    dy: initialDy,
    shape,
    level: levelIndex,
    scoreValue,
    id,
    parentId: assignedParentId,
    rotation,
    rotationSpeed,
    creationTime: now,
  });

  obstacles.push(obstacle);

  if (levelIndex === 0) {
    newAsteroidsSpawned++;
  }
}

/**
 * Updates obstacles, removes out of bounds or expired, spawns new if allowed.
 * @param {number} canvasWidth - Canvas width.
 * @param {number} canvasHeight - Canvas height.
 * @param {number} spawnInterval - Spawn interval.
 * @param {Object} lastSpawnTimeRef - Reference to last spawn time.
 * @param {boolean} [allowSpawning=true] - Whether spawning is allowed.
 */
export function updateObstacles(canvasWidth, canvasHeight, spawnInterval, lastSpawnTimeRef, allowSpawning = true) {
  const now = Date.now();

  for (let i = 0; i &lt; obstacles.length; i++) {
    const o = obstacles[i];

    if (!o.creationTime) o.creationTime = now;

    o.y += o.speed + o.dy;
    o.x += o.dx;
    o.rotation = (o.rotation + o.rotationSpeed) % (2 * Math.PI);

    const outOfBounds =
      o.y > canvasHeight + GAME_CONFIG.SPAWN_MARGIN ||
      o.x + o.radius * 2 &lt; -GAME_CONFIG.SPAWN_MARGIN ||
      o.x > canvasWidth + GAME_CONFIG.SPAWN_MARGIN;

    const tooOld = now - o.creationTime > GAME_CONFIG.MAX_LIFETIME;

    if (outOfBounds || tooOld) {
      const [removed] = obstacles.splice(i, 1);

      // Decrement fragmentTracker for expired fragments
      if (
        removed.parentId != null &amp;&amp;
        removed.level === ASTEROID_CONFIG.LEVEL_SIZES.length - 1 &amp;&amp;
        typeof fragmentTracker[removed.parentId] === 'number'
      ) {
        fragmentTracker[removed.parentId]--;
        if (fragmentTracker[removed.parentId] &lt;= 0) {
          delete fragmentTracker[removed.parentId];
        }
      }

      obstaclePool.release(removed);
      i--;
    }
  }

  if (allowSpawning &amp;&amp; now - lastSpawnTimeRef.value > spawnInterval) {
    createObstacle(
      Math.random() * (canvasWidth - ASTEROID_CONFIG.LEVEL_SIZES[0] * 2),
      -ASTEROID_CONFIG.LEVEL_SIZES[0] * 2,
      0
    );
    lastSpawnTimeRef.value = now;
  }
}

/**
 * Draws all obstacles on the canvas.
 * @param {CanvasRenderingContext2D} ctx - Canvas context.
 */
export function drawObstacles(ctx) {
  ctx.strokeStyle = '#ff4500';
  ctx.lineWidth = 2;
  obstacles.forEach(o => {
    ctx.save();
    ctx.translate(o.x + o.radius, o.y + o.radius);
    ctx.rotate(o.rotation);
    ctx.beginPath();
    ctx.moveTo(o.shape[0].x, o.shape[0].y);
    for (let i = 1; i &lt; o.shape.length; i++) {
      ctx.lineTo(o.shape[i].x, o.shape[i].y);
    }
    ctx.closePath();
    ctx.stroke();
    ctx.restore();
  });
}

/**
 * Destroys an obstacle, releases to pool, spawns fragments if applicable.
 * @param {Object} obstacle - The obstacle to destroy.
 * @param {Object} scoreRef - Reference to score.
 */
export function destroyObstacle(obstacle, scoreRef) {
  const idx = obstacles.indexOf(obstacle);
  if (idx === -1) return;

  obstacles.splice(idx, 1);
  obstaclePool.release(obstacle);
  playSound('break');

  if (obstacle.level &lt; ASTEROID_CONFIG.LEVEL_SIZES.length - 1) {
    const nextLevel = obstacle.level + 1;
    const numNew = randomInt(ASTEROID_CONFIG.FRAGMENTS_MIN, ASTEROID_CONFIG.FRAGMENTS_MAX);
    for (let k = 0; k &lt; numNew; k++) {
      const angle = Math.random() * Math.PI * 2;
      const scatterSpeed = Math.random() &lt; 0.8
        ? randomFloat(0.3, 1.0)
        : randomFloat(1.0, 2.5);
      // Inherit parent velocity plus random scatter
      const dx = obstacle.dx + Math.cos(angle) * scatterSpeed;
      const dy = obstacle.dy + Math.sin(angle) * scatterSpeed;
      createObstacle(
        obstacle.x + obstacle.radius,
        obstacle.y + obstacle.radius,
        nextLevel,
        dx,
        dy,
        obstacle.parentId ?? obstacle.id
      );
    }
  }

  scoreRef.value += obstacle.scoreValue;
  addScorePopup(`+${obstacle.scoreValue}`, obstacle.x + obstacle.radius, obstacle.y);

  if (obstacle.parentId !== null &amp;&amp; obstacle.level === ASTEROID_CONFIG.LEVEL_SIZES.length - 1) {
    fragmentTracker[obstacle.parentId]--;
    if (fragmentTracker[obstacle.parentId] === 0) {
      scoreRef.value += ASTEROID_CONFIG.FRAGMENT_BONUS;
      addScorePopup(`+${ASTEROID_CONFIG.FRAGMENT_BONUS} (All Fragments)`, obstacle.x, obstacle.y - 10, '#00ff00');
      delete fragmentTracker[obstacle.parentId];
    }
  }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="logger.html">logger</a></li></ul><h3>Classes</h3><ul><li><a href="ObjectPool.html">ObjectPool</a></li><li><a href="SpatialGrid.html">SpatialGrid</a></li><li><a href="Timer.html">Timer</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ASTEROIDS_PER_LEVEL">ASTEROIDS_PER_LEVEL</a></li><li><a href="global.html#ASTEROID_CONFIG">ASTEROID_CONFIG</a></li><li><a href="global.html#BULLET_CONFIG">BULLET_CONFIG</a></li><li><a href="global.html#FIRE_COOLDOWN_MS">FIRE_COOLDOWN_MS</a></li><li><a href="global.html#GAME_CONFIG">GAME_CONFIG</a></li><li><a href="global.html#LEVEL_CONFIG">LEVEL_CONFIG</a></li><li><a href="global.html#LogLevel">LogLevel</a></li><li><a href="global.html#MAX_WAIT">MAX_WAIT</a></li><li><a href="global.html#MOBILE_CONFIG">MOBILE_CONFIG</a></li><li><a href="global.html#POWERUP_CONFIG">POWERUP_CONFIG</a></li><li><a href="global.html#POWERUP_TYPES">POWERUP_TYPES</a></li><li><a href="global.html#__getMobileState">__getMobileState</a></li><li><a href="global.html#__setMobileOverride">__setMobileOverride</a></li><li><a href="global.html#_detectMobile">_detectMobile</a></li><li><a href="global.html#acquireBullet">acquireBullet</a></li><li><a href="global.html#activatePowerup">activatePowerup</a></li><li><a href="global.html#activePowerups">activePowerups</a></li><li><a href="global.html#addScorePopup">addScorePopup</a></li><li><a href="global.html#allowSpawning">allowSpawning</a></li><li><a href="global.html#applyVolumeAndMute">applyVolumeAndMute</a></li><li><a href="global.html#audioUnlockAttempted">audioUnlockAttempted</a></li><li><a href="global.html#bullets">bullets</a></li><li><a href="global.html#canvasEl">canvasEl</a></li><li><a href="global.html#capitalize">capitalize</a></li><li><a href="global.html#checkBulletObstacleCollisions">checkBulletObstacleCollisions</a></li><li><a href="global.html#checkCollisions">checkCollisions</a></li><li><a href="global.html#checkPlayerObstacleCollision">checkPlayerObstacleCollision</a></li><li><a href="global.html#circleRectCollision">circleRectCollision</a></li><li><a href="global.html#clamp">clamp</a></li><li><a href="global.html#clampToCanvas">clampToCanvas</a></li><li><a href="global.html#clearAllBullets">clearAllBullets</a></li><li><a href="global.html#colors">colors</a></li><li><a href="global.html#continueGame">continueGame</a></li><li><a href="global.html#createAudioControls">createAudioControls</a></li><li><a href="global.html#createLogger">createLogger</a></li><li><a href="global.html#createObstacle">createObstacle</a></li><li><a href="global.html#currentVolume">currentVolume</a></li><li><a href="global.html#debug">debug</a></li><li><a href="global.html#despawnBullet">despawnBullet</a></li><li><a href="global.html#destroyObstacle">destroyObstacle</a></li><li><a href="global.html#drawBullets">drawBullets</a></li><li><a href="global.html#drawObstacles">drawObstacles</a></li><li><a href="global.html#drawPlayer">drawPlayer</a></li><li><a href="global.html#drawPowerupTimers">drawPowerupTimers</a></li><li><a href="global.html#drawPowerups">drawPowerups</a></li><li><a href="global.html#drawScore">drawScore</a></li><li><a href="global.html#drawScorePopups">drawScorePopups</a></li><li><a href="global.html#error">error</a></li><li><a href="global.html#fireBullet">fireBullet</a></li><li><a href="global.html#fireCooldown">fireCooldown</a></li><li><a href="global.html#firePlayerBullets">firePlayerBullets</a></li><li><a href="global.html#fireTimeoutId">fireTimeoutId</a></li><li><a href="global.html#firing">firing</a></li><li><a href="global.html#forceAudioUnlock">forceAudioUnlock</a></li><li><a href="global.html#gameLevel">gameLevel</a></li><li><a href="global.html#gameLoop">gameLoop</a></li><li><a href="global.html#gameState">gameState</a></li><li><a href="global.html#generateAsteroidShape">generateAsteroidShape</a></li><li><a href="global.html#getCanvasCenter">getCanvasCenter</a></li><li><a href="global.html#getCanvasDimensions">getCanvasDimensions</a></li><li><a href="global.html#getPlayerDimensions">getPlayerDimensions</a></li><li><a href="global.html#getPlayerSpeed">getPlayerSpeed</a></li><li><a href="global.html#getPlayerVelocity">getPlayerVelocity</a></li><li><a href="global.html#getSpawnInterval">getSpawnInterval</a></li><li><a href="global.html#getTimestamp">getTimestamp</a></li><li><a href="global.html#handleFirstTouch">handleFirstTouch</a></li><li><a href="global.html#handlePlayerHit">handlePlayerHit</a></li><li><a href="global.html#hideAllOverlays">hideAllOverlays</a></li><li><a href="global.html#info">info</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initializeCanvas">initializeCanvas</a></li><li><a href="global.html#isAudioUnlocked">isAudioUnlocked</a></li><li><a href="global.html#isMobile">isMobile</a></li><li><a href="global.html#isMuted">isMuted</a></li><li><a href="global.html#isPointInCanvas">isPointInCanvas</a></li><li><a href="global.html#isTouch">isTouch</a></li><li><a href="global.html#lastFireTime">lastFireTime</a></li><li><a href="global.html#lastObstacleSpawnTime">lastObstacleSpawnTime</a></li><li><a href="global.html#lerp">lerp</a></li><li><a href="global.html#levelClearTime">levelClearTime</a></li><li><a href="global.html#levelStartTime">levelStartTime</a></li><li><a href="global.html#log">log</a></li><li><a href="global.html#mapRange">mapRange</a></li><li><a href="global.html#mobileOverride">mobileOverride</a></li><li><a href="global.html#movePlayer">movePlayer</a></li><li><a href="global.html#muteAll">muteAll</a></li><li><a href="global.html#newAsteroidsSpawned">newAsteroidsSpawned</a></li><li><a href="global.html#obstacles">obstacles</a></li><li><a href="global.html#pauseLocked">pauseLocked</a></li><li><a href="global.html#pendingLevelUp">pendingLevelUp</a></li><li><a href="global.html#playSound">playSound</a></li><li><a href="global.html#player">player</a></li><li><a href="global.html#playerLives">playerLives</a></li><li><a href="global.html#powerUps">powerUps</a></li><li><a href="global.html#quitGame">quitGame</a></li><li><a href="global.html#randomFloat">randomFloat</a></li><li><a href="global.html#randomInt">randomInt</a></li><li><a href="global.html#reactive">reactive</a></li><li><a href="global.html#releaseBullet">releaseBullet</a></li><li><a href="global.html#renderAll">renderAll</a></li><li><a href="global.html#resetForNextLevel">resetForNextLevel</a></li><li><a href="global.html#resetLevelFlow">resetLevelFlow</a></li><li><a href="global.html#resetNewAsteroidsSpawned">resetNewAsteroidsSpawned</a></li><li><a href="global.html#resetPlayer">resetPlayer</a></li><li><a href="global.html#restartGameLoop">restartGameLoop</a></li><li><a href="global.html#score">score</a></li><li><a href="global.html#scorePopupPool">scorePopupPool</a></li><li><a href="global.html#scorePopups">scorePopups</a></li><li><a href="global.html#setCanvas">setCanvas</a></li><li><a href="global.html#setOverlayDimensions">setOverlayDimensions</a></li><li><a href="global.html#setPlayerMovement">setPlayerMovement</a></li><li><a href="global.html#setPlayerPosition">setPlayerPosition</a></li><li><a href="global.html#setVolume">setVolume</a></li><li><a href="global.html#setupDevelopment">setupDevelopment</a></li><li><a href="global.html#setupInput">setupInput</a></li><li><a href="global.html#setupMobileInput">setupMobileInput</a></li><li><a href="global.html#setupProduction">setupProduction</a></li><li><a href="global.html#setupStarfield">setupStarfield</a></li><li><a href="global.html#show">show</a></li><li><a href="global.html#showOverlay">showOverlay</a></li><li><a href="global.html#sounds">sounds</a></li><li><a href="global.html#spawnPowerup">spawnPowerup</a></li><li><a href="global.html#startGame">startGame</a></li><li><a href="global.html#startMusic">startMusic</a></li><li><a href="global.html#stopFiring">stopFiring</a></li><li><a href="global.html#stopGameLoop">stopGameLoop</a></li><li><a href="global.html#stopMusic">stopMusic</a></li><li><a href="global.html#supportsVibration">supportsVibration</a></li><li><a href="global.html#touchActive">touchActive</a></li><li><a href="global.html#touchX">touchX</a></li><li><a href="global.html#touchY">touchY</a></li><li><a href="global.html#unmuteAll">unmuteAll</a></li><li><a href="global.html#updateBullets">updateBullets</a></li><li><a href="global.html#updateLevelFlow">updateLevelFlow</a></li><li><a href="global.html#updateObstacles">updateObstacles</a></li><li><a href="global.html#updatePlayer">updatePlayer</a></li><li><a href="global.html#updatePlayerToTouch">updatePlayerToTouch</a></li><li><a href="global.html#updatePowerups">updatePowerups</a></li><li><a href="global.html#updateScorePopups">updateScorePopups</a></li><li><a href="global.html#warn">warn</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Mon Dec 01 2025 00:17:51 GMT-0600 (Central Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
